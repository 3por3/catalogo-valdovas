<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOMAD V61 LAUNDER</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 15px; }
        
        .box { 
            border: 1px solid #0f0; 
            padding: 15px; border-radius: 8px; 
            margin-bottom: 20px; background: #111; 
            box-shadow: 0 0 15px rgba(0,255,0,0.15); 
        }
        
        h3 { text-align: center; border-bottom: 1px solid #0f0; padding-bottom: 10px; color: #fff; letter-spacing: 2px; }
        
        #reader { width: 100%; background: #000; min-height: 250px; border-radius: 4px; border: 1px solid #333; }
        
        .btn-main { width: 100%; padding: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; text-transform: uppercase; }
        
        /* IMAGEN */
        .img-container {
            width: 100%; height: 250px; background: #050505;
            border: 1px solid #333; display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; position: relative; overflow: hidden;
        }
        
        #prod_img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        
        .source-badge {
            position: absolute; bottom: 0; right: 0;
            background: rgba(0,255,0,0.8); color: #000; font-weight: bold;
            font-size: 0.7rem; padding: 2px 6px; z-index: 10;
        }
        
        .data-title { color: #666; font-size: 0.7rem; margin-top: 5px; text-transform: uppercase; }
        .data-content { font-size: 1.1rem; font-weight: bold; color: #fff; min-height: 20px; margin-bottom: 10px; border-left: 3px solid #0f0; padding-left: 10px; }
        
        #loading { display:none; text-align:center; color: #ffff00; margin-top: 10px; }
    </style>
</head>
<body>

<div class="box" id="scan_screen">
    <h3><i class="bi bi-droplet-half"></i> NOMAD V61</h3>
    
    <div id="reader"></div>
    <div id="loading"><div class="spinner-border text-warning"></div> Procesando...</div>

    <button id="btn_start" class="btn btn-success btn-main" onclick="activarCamara()">
        <i class="bi bi-camera-fill"></i> ESCANEAR
    </button>
    
    <div class="input-group mt-4">
        <input type="number" id="manual_code" class="form-control bg-dark text-white border-success" placeholder="Código manual...">
        <button class="btn btn-outline-success" onclick="procesarDatos(document.getElementById('manual_code').value)">IR</button>
    </div>
</div>

<div class="box" id="result_screen" style="display:none;">
    <div class="d-flex justify-content-between">
        <span class="text-secondary" style="font-size:0.8rem">RESULTADO V61</span>
        <button class="btn btn-sm btn-outline-danger" onclick="reiniciar()"><i class="bi bi-x-lg"></i></button>
    </div>
    
    <div id="res_code" style="font-family: monospace; color:#0f0; font-size: 1.2rem; margin-bottom:10px;">---</div>

    <div class="img-container">
        <div id="img_loader" class="spinner-border text-secondary" role="status"></div>
        <img id="prod_img" src="" onerror="imagenFallo(this)">
        <div id="img_source" class="source-badge" style="display:none">GO-UPC</div>
    </div>

    <div class="data-title">NOMBRE DETECTADO</div>
    <div id="res_name" class="data-content"><div class="spinner-border spinner-border-sm"></div> Buscando...</div>

    <a id="btn_target" href="#" target="_blank" class="btn btn-danger btn-main">
        <i class="bi bi-bullseye"></i> TARGET
    </a>
    
    <a id="btn_goupc" href="#" target="_blank" class="btn btn-primary btn-main" style="margin-top:5px;">
        <i class="bi bi-search"></i> VER EN GO-UPC
    </a>
    
    <button onclick="reiniciar()" class="btn btn-outline-secondary btn-main mt-3">
        SIGUIENTE <i class="bi bi-arrow-clockwise"></i>
    </button>
</div>

<script>
    let scanner = null;
    let imgEncontrada = false;

    function activarCamara() {
        document.getElementById('btn_start').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                scanner.stop().then(() => procesarDatos(decodedText));
            }, () => {}
        ).catch(err => {
            document.getElementById('loading').innerText = "Error cámara (HTTPS requerido)";
            document.getElementById('btn_start').style.display = 'block';
        });
    }

    async function procesarDatos(codigo) {
        if(!codigo) return;
        
        imgEncontrada = false;
        
        // UI Reset
        document.getElementById('scan_screen').style.display = 'none';
        document.getElementById('result_screen').style.display = 'block';
        document.getElementById('res_code').innerText = codigo;
        document.getElementById('res_name').innerHTML = '<div class="spinner-border spinner-border-sm text-success"></div> Analizando...';
        document.getElementById('prod_img').style.display = 'none';
        document.getElementById('img_loader').style.display = 'block';
        document.getElementById('img_source').style.display = 'none';

        document.getElementById('btn_target').href = `https://www.google.com/search?q=site:target.com "${codigo}"`;
        document.getElementById('btn_goupc').href = `https://go-upc.com/search?q=${codigo}`;

        // HILO 1: GO-UPC (Con "Lavado de Imagen")
        const goUpcUrl = `https://go-upc.com/search?q=${codigo}`;
        const proxyGoUpc = `https://api.allorigins.win/get?url=${encodeURIComponent(goUpcUrl)}&timestamp=${Date.now()}`;
        
        fetch(proxyGoUpc).then(res => res.json()).then(data => {
            if (data.contents) {
                const doc = new DOMParser().parseFromString(data.contents, "text/html");
                
                // 1. NOMBRE
                const ogTitle = doc.querySelector('meta[property="og:title"]');
                if (ogTitle && ogTitle.content) {
                    let nombre = ogTitle.content.replace(`UPC ${codigo}`, "").replace("|", "").trim();
                    if(nombre.length > 3) document.getElementById('res_name').innerText = nombre;
                }

                // 2. IMAGEN (EL TRUCO NUEVO)
                const ogImg = doc.querySelector('meta[property="og:image"]');
                if (ogImg && ogImg.content && !ogImg.content.includes("placeholder")) {
                    const urlOriginal = ogImg.content;
                    // AQUÍ ESTÁ LA MAGIA: Pasamos la URL por wsrv.nl para limpiarla
                    const urlLavada = `https://wsrv.nl/?url=${encodeURIComponent(urlOriginal)}&w=400&output=webp`;
                    mostrarImagen(urlLavada, "GO-UPC");
                }
            }
        }).catch(e => console.log("Go-UPC Error"));

        // HILO 2: UPCItemDB (Respaldo)
        setTimeout(() => {
            if (!imgEncontrada) {
                fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${codigo}`)
                .then(res => res.json())
                .then(data => {
                    if(data.items && data.items.length > 0 && data.items[0].images.length > 0) {
                        if (!imgEncontrada) {
                            mostrarImagen(data.items[0].images[0], "UPC-DB");
                            if (document.getElementById('res_name').innerHTML.includes("spinner")) {
                                document.getElementById('res_name').innerText = data.items[0].title;
                            }
                        }
                    }
                });
            }
        }, 1500); // Esperamos 1.5s a ver si Go-UPC responde primero
    }

    function mostrarImagen(url, fuente) {
        const imgEl = document.getElementById('prod_img');
        imgEl.src = url;
        imgEl.onload = () => {
            imgEncontrada = true;
            document.getElementById('img_loader').style.display = 'none';
            imgEl.style.display = 'block';
            const badge = document.getElementById('img_source');
            badge.innerText = fuente;
            badge.style.display = 'block';
            badge.style.background = (fuente === "GO-UPC") ? "#0f0" : "#ffaa00";
        };
    }

    function imagenFallo(img) {
        // Si falla incluso con el lavado, ocultamos
        img.style.display = 'none';
    }

    function reiniciar() {
        document.getElementById('result_screen').style.display = 'none';
        document.getElementById('scan_screen').style.display = 'block';
        document.getElementById('btn_start').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('reader').innerHTML = "";
    }
</script>
</body>
</html>